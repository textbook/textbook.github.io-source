<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width">
  <title>textbook - twitter</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css">
    <link rel="stylesheet" href="../theme/css/main.557acf99.css">
  <style media="print">.is-hidden-print{display:none !important}</style>
      <link rel="stylesheet" href="../custom.css">
</head>

<body id="index" class="home">
<header class="hero is-primary">
  <div class="hero-head">
    <div class="container">
      <nav class="navbar">
        <div class="navbar-brand">
          <a class="navbar-item title is-3"
             href="../">textbook</a>
        </div>
      </nav>
    </div>
  </div>
</header>

<nav class="navbar has-shadow is-hidden-print">
  <div class="container">
    <div class="navbar-center"></div>
    <span id="navToggle" class="navbar-burger">
      <span></span>
      <span></span>
      <span></span>
    </span>
    <div id="navMenu" class="navbar-menu">
        <div class="navbar-end">
              <a class="navbar-item is-tab "
                 href="../category/work.html">work</a>
              <a class="navbar-item is-tab "
                 href="../category/meta.html">meta</a>
              <a class="navbar-item is-tab "
                 href="../category/development.html">development</a>
        </div>
    </div>
  </div>
</nav>

<div class="container">
  <div class="section columns">
    <div class="column is-three-quarters-desktop is-two-thirds-tablet">
      <aside id="featured" class="body">
        <article>
          <h1 class="title">
            <a href="../2017/May/14/eleanor-rigbot.html">Eleanor Rigbot</a>
          </h1>
<footer class="post-info">
  <abbr class="published" title="2017-05-14T13:00:00+01:00">
    Published <span class="is-info">Sun 14 May 2017</span>
    in <a href="../category/development.html">development</a>
  </abbr>

    <p class="author">
      <em>by           Jonathan Sharpe
</em>
      <span class="tag is-small is-rounded">
        <a href="../tag/code.html">code</a>
      </span>
      <span class="tag is-small is-rounded">
        <a href="../tag/python.html">python</a>
      </span>
      <span class="tag is-small is-rounded">
        <a href="../tag/twitter.html">twitter</a>
      </span>
    </p>
  
</footer>          <div class="section">
            <blockquote>
<p>Eleanor Rigby, picks up the rice </p>
<p>In the church where a wedding has been</p>
<p>Lives in a dream</p>
<p><small><strong>Eleanor Rigby</strong>, by the Beatles (<em>Lennon-McCartney, 1966</em>).</small></p>
</blockquote>
<p>The song <a href="https://en.wikipedia.org/wiki/Eleanor_Rigby">Eleanor Rigby</a> has a distinctive syllabic pattern and rhyming
scheme, and it's fun to try and come up with additional verses. But what if we
could find them automatically, instead?</p>
<p>Since the people behind Clitoris Vulgaris (<a href="https://twitter.com/clitoscope">@clitoscope</a>), a Twitter bot
designed to <em>"generate new species of clitoris by projecting botanical
illustrations onto a 3D model"</em>, gave a talk at work about how they built it,
I've been interested in the idea of making a bot of my own. Creating something
to look for tweets that could be a new verse seemed doable as a first attempt.</p>
<h2>Libraries</h2>
<p>I'd initially looked at using <a href="http://www.nltk.org/index.html">NLTK</a> to do the language processing; one
corpus available for it, the Carnegie Mellon Pronouncing Dictionary, seemed
perfect for the project. However, I wasn't sure how to go about running an 
NLTK-based app on Cloud Foundry, as it needs to download the corpus once <code>pip
install</code>-ed. Fortunately, someone else had already done the hard work for me
and wrapped that single corpus in a library named <a href="https://pypi.python.org/pypi/pronouncing"><code>pronouncing</code></a>; using
this made the bot trivial to deploy. This allows for both determining the
syllables in the words used and whether two given words rhyme.</p>
<p>Using the <a href="http://docs.tweepy.org/en/latest/">Tweepy</a> library made interacting with Twitter simple; I
subclassed the existing <code>StreamListener</code> with my own <code>RetweetListener</code>, which
takes an <code>extractor</code> (for extracting the text to process from a tweet) and a
<code>filterer</code> (for filtering out tweets that should be retweeted). This keeps it
very general for reuse later. Tweets are not exactly written in formal English
and contain things like usernames, hashtags and URLs that can't necessarily be
pronounced, so the current extractor takes the longest string of <em>"clean
characters"</em> (the letters A-Z plus some basic punctuation characters, not
including characters like <code>@</code> and <code>#</code> with Twitter-specific meanings) from each
tweet to pass to the filtering.</p>
<h2>Classification</h2>
<p>The actual classification happens in <a href="https://github.com/textbook/eleanor-rigbot/blob/9bedfdce7def83cb13021e3751f55716d9a3a307/eleanorrigbot/classify.py#L42"><code>PhraseMatcher.__call__</code></a>, and the
overall process is pretty straightforward:</p>
<ol>
<li>Given a phrase string, e.g. <code>'here are some example words'</code>;</li>
<li>Create a list of the individual words and their lengths in syllables, e.g.
    <code>[('here', 1), ('are', 1), ('some', 1), ('example', 3), ('words', 1)]</code></li>
<li>If any word couldn't be processed or the total syllable count doesn't match
    the pattern we're looking for, return <code>False</code>;</li>
<li>Try to fit the words into the required syllable pattern, assuming that we
    want lines to break on words;</li>
<li>If the phrase doesn't fit into the syllable pattern, return <code>False</code>; and</li>
<li>Return whether or not the phrase matches the required rhyming scheme.</li>
</ol>
<p>The scheme is defined with two sequences: one of the number of syllables in
each line; and one of the required rhyming scheme. For example, the scheme to
match a verse of Eleanor Rigby is:</p>
<div class="highlight"><pre><span></span><span class="n">ELEANOR_RIGBY</span> <span class="o">=</span> <span class="n">PhraseMatcher</span><span class="p">(</span>
    <span class="n">syllable_pattern</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
    <span class="n">rhyming_scheme</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>


<p>This means:</p>
<ul>
<li>there should be four lines, with five, four, nine and four syllables
   respectively (for a total of 22); and</li>
<li>the third and fourth lines must rhyme (but we don't care whether or not the
   first two lines rhyme with anything).</li>
</ul>
<p>This representation makes the bot configurable for different phrases, including
the other example I give in the README (note that here the rhyme scheme is
marked with letters - it gets converted to a dictionary mapping group ID to
line indices, so anything hashable is fine):</p>
<div class="highlight"><pre><span></span><span class="c1"># https://www.flickr.com/places/info/12591829</span>
<span class="n">napoli</span> <span class="o">=</span> <span class="p">[</span><span class="mf">13.8509</span><span class="p">,</span> <span class="mf">40.5360</span><span class="p">,</span> <span class="mf">14.6697</span><span class="p">,</span> <span class="mf">41.0201</span><span class="p">]</span>

<span class="c1"># &quot;when the moon hits your eye like a big pizza pie&quot;</span>
<span class="n">that_is_amore</span> <span class="o">=</span> <span class="n">PhraseMatcher</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">))</span>

<span class="n">start_listening</span><span class="p">(</span><span class="n">napoli</span><span class="p">,</span> <span class="n">that_is_amore</span><span class="p">)</span>
</pre></div>


<h2>Results</h2>
<p>The very first retweet is probably still the best so far:</p>
<blockquote>
<p>It's kinda shitty when people say they care then act like they don't give
two shits about you</p>
<p><small>Charley Emmett (@Ch4rl3y_B0y) <a href="https://twitter.com/Ch4rl3y_B0y/status/850067453761773569">April 6, 2017</a></small></p>
</blockquote>
<p>which becomes:</p>
<blockquote>
<p>It's kinda shitty, when people say</p>
<p>They care then act like they don't give two</p>
<p>Shits about you</p>
</blockquote>
<p>Aside from an overly-strict definition of rhyming (some rhymes from the actual
song, like <em>"grave"</em> and <em>"saved"</em>, aren't considered valid), the
classification seems to be working pretty effectively. The extraction is not as
good; it doesn't necessarily find the real content of the status correctly. For
example, one of the weakest matches so far is:</p>
<blockquote>
<p>Away to <a href="https://twitter.com/NewportSarries">@NewportSarries</a> tomorrow </p>
<p>End of the season is in sight </p>
<p>And it's going to be a glorious day ðŸŒžjust what you want as a front row</p>
<p><small>Malpas RFC (@MalpasRugbyClub) <a href="https://twitter.com/MalpasRugbyClub/status/850270568066588672">April 7, 2017</a></small></p>
</blockquote>
<p>This is being classified as:</p>
<blockquote>
<p>Tomorrow end of, the season is</p>
<p>In sight and it's going to be a</p>
<p>Glorious day</p>
</blockquote>
<p>Most of the content of the tweet is being discarded, so it's not obvious from
reading it where the verse is.</p>
<h2>Next steps</h2>
<p>A few improvements I've thought of:</p>
<ol>
<li>
<p>To make it more obvious what the matched "verse" is, I could switch from
    retweeting to quoting, so the bot can include the match in its response.
    However, that might make it seem more invasive.</p>
</li>
<li>
<p>Instead of the separate extraction and classification steps, the extraction
    could be based on the longest series of pronounceable words in the tweet.
    This would mean using the default no-op <code>_all_text</code> extractor in the 
    <code>RetweetListener</code> and moving the extraction into the <code>PhraseMatcher</code> class.</p>
</li>
<li>
<p>It might be nice to include pronounceable user names and hashtags in the
    match, although splitting those with multiple words in may prove tricky.</p>
</li>
</ol>
<p><a href="https://commons.wikimedia.org/wiki/File:Eleanor_Rigby_-_geograph.org.uk_-_1457024.jpg#/media/File:Eleanor_Rigby_-_geograph.org.uk_-_1457024.jpg"><img alt="Eleanor Rigby - geograph.org.uk - 1457024.jpg" src="https://upload.wikimedia.org/wikipedia/commons/d/d7/Eleanor_Rigby_-_geograph.org.uk_-_1457024.jpg"></a></p>
<p><small>By john driscoll, <a href="http://creativecommons.org/licenses/by-sa/2.0" title="Creative Commons Attribution-Share Alike 2.0">CC BY-SA 2.0</a>, <a href="https://commons.wikimedia.org/w/index.php?curid=14199222">Link</a>.</small></p>
          </div>
        </article>
      </aside>
    </div>

    <div class="column is-one-quarter-desktop is-one-third-tablet is-hidden-print">
      <aside class="menu">
<div id="mc_embed_signup">
  <form
      action="https://jonrshar.us15.list-manage.com/subscribe/post?u=7ada11180797f3af73228bf0b&amp;id=d172abcbd2"
      method="post" id="mc-embedded-subscribe-form"
      name="mc-embedded-subscribe-form" class="validate" target="_blank"
      novalidate>

    <h2 class="menu-label">Mailing List</h2>

    <div id="mc_embed_signup_scroll">
      <div class="field mc-field-group">
        <label for="mce-EMAIL" class="label is-small">Email</label>
        <div class="field-body">
          <div class="field">
            <p class="control has-icons-left">
              <input type="email" name="EMAIL" class="input required email is-small"
                     id="mce-EMAIL" placeholder="Email address">
              <span class="icon is-small is-left">
              <i class="fa fa-envelope"></i>
            </span>
            </p>
          </div>
        </div>
      </div>
      <div class="field">
        <label for="mce-FNAME" class="label is-small">Name</label>
        <div class="field-body">
          <div class="field is-grouped">
            <p class="control is-expanded">
              <input class="input is-small" type="text" value="" name="FNAME"
                     id="mce-FNAME" placeholder="First">
            </p>
            <p class="control is-expanded">
              <input class="input is-small" type="text" value="" name="LNAME"
                     id="mce-LNAME" placeholder="Last">
            </p>
          </div>
        </div>
      </div>
      <div class="field is-grouped">
        <p class="control">
          <input type="submit" name="subscribe" value="Subscribe"
                 class="button is-small is-success" id="mc-embedded-subscribe">
        </p>
          <p class="control">
            <span class="help">
              Powered by
              <a href="http://eepurl.com/cNv6Rb"
                 title="MailChimp - email marketing made easy and fun">
                MailChimp
              </a>
            </span>
          </p>
      </div>

      <div id="mce-responses" class="clear">
        <div class="response help is-danger" id="mce-error-response"
             style="display:none"></div>
        <div class="response help is-success" id="mce-success-response"
             style="display:none"></div>
      </div>

      <div style="position: absolute; left: -5000px;" aria-hidden="true">
        <input type="text" name="b_7ada11180797f3af73228bf0b_d172abcbd2"
               tabindex="-1" value="">
      </div>
    </div>
  </form>
</div>

          <p class="menu-label">Other Pages</p>
          <ul class="menu-list">
                <li><a                        href="../pages/about.html">
                  <span class="icon is-small"><i class="fa fa-book"></i></span>
                  <span class="link-text">About</span>
                </a></li>
          </ul>
          <p class="menu-label">Links</p>
          <ul class="menu-list">
              <li><a href="http://engineering.pivotal.io/">
                <span class="icon is-small"><i class="fa fa-globe fa-fw"></i></span>
                <span class="link-text">Pivotal Engineering Journal</span>
              </a></li>
              <li><a href="http://blog.cleancoder.com/">
                <span class="icon is-small"><i class="fa fa-globe fa-fw"></i></span>
                <span class="link-text">The Clean Code Blog</span>
              </a></li>
              <li><a href="https://codeascraft.com/">
                <span class="icon is-small"><i class="fa fa-globe fa-fw"></i></span>
                <span class="link-text">Code as Craft</span>
              </a></li>
              <li><a href="http://corgibytes.com/blog/">
                <span class="icon is-small"><i class="fa fa-globe fa-fw"></i></span>
                <span class="link-text">Corgibytes Blog</span>
              </a></li>
          </ul>
<p class="menu-label">Social</p>
<ul class="menu-list">
    <li><a href="https://github.com/textbook">
      <span class="icon is-small">
          <i class="fa fa-github fa-fw"></i>
      </span>
      <span class="link-text">GitHub</span>
    </a></li>
    <li><a href="http://stackoverflow.com/users/3001761/jonrsharpe">
      <span class="icon is-small">
          <i class="fa fa-stack-overflow fa-fw"></i>
      </span>
      <span class="link-text">Stack Overflow</span>
    </a></li>
    <li><a href="https://twitter.com/jonrsharpe">
      <span class="icon is-small">
          <i class="fa fa-twitter fa-fw"></i>
      </span>
      <span class="link-text">Twitter</span>
    </a></li>
    <li><a href="https://500px.com/jonrsharpe">
      <span class="icon is-small">
          <i class="fa fa-500px fa-fw"></i>
      </span>
      <span class="link-text">500px</span>
    </a></li>


</ul>          <p class="menu-label">License</p>
          
<ul class="menu-list">
  <li>
    <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
      <span class="icon is-small">
        <i class="fa fa-creative-commons fa-fw"></i>
      </span>
      <span>CC BY-SA 4.0</span>
    </a>
  </li>
</ul>

      </aside>
    </div>
  </div>
</div>

<footer class="footer">
  <div class="container has-text-centered">
 <p class="subtitle">These are my opinions - if you don't like them, I have others</p>    <div class="credits">
      <span><a href="https://github.com/textbook/bulrush">Bulrush</a> theme for
        <a href="https://blog.getpelican.com/">Pelican</a></span>
      <span><span class="icon is-small"><i class="fa fa-html5"></i></span> HTML 5</span>
      <span><span class="icon is-small"><i class="fa fa-css3"></i></span> CSS 3</span>
      <span>Made with <a href="https://bulma.io">Bulma</a></span>
    </div>
  </div>
  <div class="github-fork-ribbon-wrapper is-hidden-mobile is-hidden-print">
    <div class="github-fork-ribbon">
      <a href="https://github.com/textbook/textbook.github.io-source">
        <i class="fa fa-github fa-fw"></i>
        Fork me on GitHub
      </a>
    </div>
  </div>
</footer>

<script type="text/javascript">
  document.getElementById('navToggle').addEventListener('click', function () {
    var nav = document.getElementById('navMenu');
    var className = nav.getAttribute('class');
    if (className == 'navbar-menu') {
      nav.className = 'navbar-menu is-active';
    } else {
      nav.className = 'navbar-menu';
    }
  });
</script>
</body>
</html>