<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width">
  <title>Handling data with the Angular AsyncPipe</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css">
    <link rel="stylesheet" href="../../../theme/css/main.557acf99.css">
  <style media="print">.is-hidden-print{display:none !important}</style>
      <link rel="stylesheet" href="../../../custom.css">
<meta property="og:title" content="textbook - Handling data with the Angular AsyncPipe">
  <meta property="og:description" content="Patterns for manipulating API data asynchronously using RxJS Observables in Angular.">
<meta property="og:url" content="../../../2017/Apr/09/async-angular-data.html">
    <meta property="og:image" content="../../../images/avatar.png">
    <meta name="twitter:image:alt" content="textbook | These are my opinions - if you don't like them, I have others">
<meta name="twitter:card" content="summary">
  <meta name="twitter:creator" content="@jonrsharpe">
  <meta name="twitter:site" content="@jonrsharpe">
<meta property="og:site_name" content="textbook">
<meta property="og:type" content="article">
  <meta property="article:published_time" content="2017-04-09T15:20:00+01:00">
  <meta property="article:modified_time" content="2017-04-16T15:00:00+01:00">
    <meta property="article:tag" content="code">
    <meta property="article:tag" content="angular">
    <meta property="article:tag" content="typescript">
    <meta property="article:tag" content="rxjs">
  <meta property="article:section" content="development">
</head>

<body id="index" class="home">
<header class="hero is-primary">
  <div class="hero-head">
    <div class="container">
      <nav class="navbar">
        <div class="navbar-brand">
          <a class="navbar-item title is-3"
             href="../../../">textbook</a>
        </div>
      </nav>
    </div>
  </div>
</header>

<nav class="navbar has-shadow is-hidden-print">
  <div class="container">
    <div class="navbar-center"></div>
    <span id="navToggle" class="navbar-burger">
      <span></span>
      <span></span>
      <span></span>
    </span>
    <div id="navMenu" class="navbar-menu">
        <div class="navbar-end">
              <a class="navbar-item is-tab "
                 href="../../../category/work.html">work</a>
              <a class="navbar-item is-tab "
                 href="../../../category/meta.html">meta</a>
              <a class="navbar-item is-tab is-active"
                 href="../../../category/development.html">development</a>
        </div>
    </div>
  </div>
</nav>

<div class="container">
  <div class="section columns">
    <div class="column is-three-quarters-desktop is-two-thirds-tablet">
<section id="content" class="body">
  <article>
    <h1 class="title">
      <a href="../../../2017/Apr/09/async-angular-data.html" rel="bookmark"
         title="Permalink to Handling data with the Angular AsyncPipe">Handling data with the Angular AsyncPipe</a></h1>
<footer class="post-info">
  <abbr class="published" title="2017-04-09T15:20:00+01:00">
    Published <span class="is-info">Sun 09 April 2017</span>
    in <a href="../../../category/development.html">development</a>
  </abbr>
    <br />
    <abbr class="modified" title="2017-04-16T15:00:00+01:00">
      Updated Sun 16 April 2017
    </abbr>

    <p class="author">
      <em>by           Jonathan Sharpe
</em>
      <span class="tag is-small is-rounded">
        <a href="../../../tag/code.html">code</a>
      </span>
      <span class="tag is-small is-rounded">
        <a href="../../../tag/angular.html">angular</a>
      </span>
      <span class="tag is-small is-rounded">
        <a href="../../../tag/typescript.html">typescript</a>
      </span>
      <span class="tag is-small is-rounded">
        <a href="../../../tag/rxjs.html">rxjs</a>
      </span>
    </p>
  
</footer>    <div class="section"><p>In my current project at work, we're using <a href="https://angular.io/">Angular</a> to build the front end 
of a web application that gives the user a dashboard of useful information. As 
part of this we've adopted a few patterns for handling data that I thought 
would be useful to others. </p>
<h2>Asynchronous data sources</h2>
<p>Say we want to get a random person from <a href="https://randomuser.me">randomuser.me</a>, so that we can show 
their first name. We might start with a service that looks like:</p>
<div class="highlight"><pre><span></span><span class="kd">@Injectable</span><span class="p">()</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">RandomUserService</span> <span class="p">{</span>
  <span class="kr">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">http</span>: <span class="kt">Http</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

  <span class="nx">getRandomUser() {</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span>
      <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;https://randomuser.me/api/&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>In our component we then <code>.subscribe</code> to the resulting observable and assign 
the data to a field:</p>
<div class="highlight"><pre><span></span><span class="kd">@Component</span><span class="p">({</span>
  <span class="nx">selector</span><span class="o">:</span> <span class="s1">&#39;random-user&#39;</span><span class="p">,</span>
  <span class="nx">template</span><span class="o">:</span> <span class="s1">&#39;&lt;span&gt;{{ user.name.first }}&lt;/span&gt;&#39;</span><span class="p">,</span>
<span class="p">})</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">RandomUserComponent</span> <span class="p">{</span>
  <span class="nx">user</span><span class="p">;</span>

  <span class="kr">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">service</span>: <span class="kt">RandomUserService</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

  <span class="nx">ngOnInit() {</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">getRandomUser</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">user</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">user</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>However, you quickly run into issues; prior to the GET call resolving via the 
subscription, <code>this.user</code> is <code>null</code>, so getting the appropriate fields from it 
fails:</p>
<div class="highlight"><pre><span></span><span class="n">TypeError</span><span class="o">:</span> <span class="n">Cannot</span> <span class="n">read</span> <span class="n">property</span> <span class="s1">&#39;name&#39;</span> <span class="n">of</span> <span class="kc">null</span> <span class="o">...</span>
</pre></div>


<p>and the view doesn't render at all. </p>
<h2>Simple solutions</h2>
<p>To avoid this, you could set a default value, so that the appropriate fields 
always exist:</p>
<div class="highlight"><pre><span></span><span class="nx">user</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="p">{</span> <span class="nx">first</span><span class="o">:</span> <span class="s1">&#39;Alice&#39;</span> <span class="p">}</span> <span class="p">};</span>
</pre></div>


<p>However, it's not always obvious what an appropriate default would be, and if 
the request fails the end user is potentially stuck looking at some dummy data. </p>
<p>Alternatively we can use <a href="https://angular.io/docs/ts/latest/guide/template-syntax.html#!%23safe-navigation-operator">the safe navigation operator</a> to resolve each 
field:</p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>{{ user?.name?.first }}<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</pre></div>


<p>but that's not too neat and is prone to human error.</p>
<h2>Leveraging observables</h2>
<p>Instead, we can use the <code>AsyncPipe</code> to resolve the value asynchronously from 
the service:</p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>{{ firstName$ | async }}<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</pre></div>


<p><em>(The convention of a dollar sign suffix to indicate an observable was 
apparently <a href="https://cycle.js.org/basic-examples.html#basic-examples-increment-a-counter-what-is-the-convention">popularised by Cycle.js</a>.)</em></p>
<p>In the component, this can be implemented as a property:</p>
<div class="highlight"><pre><span></span><span class="nx">get</span> <span class="nx">firstName$() {</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">randomUser$</span>
    <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">user</span> <span class="o">=&gt;</span> <span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">first</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>In the service, we've been using a <em>"public observable, private subject"</em> 
pattern:</p>
<div class="highlight"><pre><span></span><span class="kd">@Injectable</span><span class="p">()</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">RandomUserService</span> <span class="p">{</span>
  <span class="kr">private</span> <span class="nx">userSubject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ReplaySubject</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

  <span class="nx">randomUser$</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">userSubject</span><span class="p">.</span><span class="nx">asObservable</span><span class="p">();</span>

  <span class="kr">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">http</span>: <span class="kt">Http</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

  <span class="nx">fetchRandomUser() {</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">http</span>
      <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;https://randomuser.me/api/&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">user</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">userSubject</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">user</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Using a <code>ReplaySubject</code> means that new subscribers, joining after a fetch, 
still get the latest value. Keeping it private means that the subscribers can't 
push new data into it, so we know any new state must come from within the 
service itself. Any component can trigger a new request via the public 
<code>fetch...</code> method, and all subscribers then get the newest data as it arrives. </p>
<h2>Combining data sources</h2>
<p>In a few cases, we want to combine multiple requests (for example, to draw a 
graph using data from two API endpoints). Initially this seemed quite tricky, 
as we wouldn't necessarily know when both requests had resolved. However, RxJS 
provides <code>combineLatest</code> for this purpose:</p>
<div class="highlight"><pre><span></span><span class="nx">ngOnInit() {</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">combinedData$</span> <span class="o">=</span> <span class="nx">Observable</span><span class="p">.</span><span class="nx">combineLatest</span><span class="p">(</span>
    <span class="nx">service</span><span class="p">.</span><span class="nx">someData$</span><span class="p">,</span>
    <span class="nx">service</span><span class="p">.</span><span class="nx">otherData$</span><span class="p">,</span>
    <span class="p">(</span><span class="nx">some</span><span class="p">,</span> <span class="nx">other</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">combine</span><span class="p">(</span><span class="nx">some</span><span class="p">,</span> <span class="nx">other</span><span class="p">)</span>  <span class="c1">// or &quot;this.combine.bind(this)&quot;</span>
  <span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>See e.g. <a href="http://rxmarbles.com/#combineLatest">RxMarbles</a> for a demonstration of what this operator does, as well 
as other operators that can be applied to your streams of data. </p>
<h2>Gotchas</h2>
<p>Note a few problems we've run into:</p>
<ul>
<li><code>ExpressionChangedAfterItHasBeenCheckedError</code> on anything that passes <code>NaN</code> 
    into <code>| async</code>; I opened <a href="https://github.com/angular/angular/issues/15721">an issue</a> about this and there's <a href="https://github.com/angular/angular/pull/15723">a pull 
    request</a> to fix it. </li>
<li>Exposing error states with a <code>ReplaySubject</code> can lead to some weird 
    behaviour; use a vanilla <code>Subject</code> instead, to avoid errors getting 
    replayed later. </li>
</ul>
<blockquote>
<p>For more information on testing services and components written in this way, 
see the follow-up article <a href="../../../2017/Apr/16/async-angular-tests.html">Testing async data in Angular</a>.</p>
</blockquote></div>

  </article>
</section>

<script type="application/ld+json">
  {"articleSection": "development", "author": {"@type": "Person", "name": "Jonathan Sharpe"}, "datePublished": "2017-04-09T15:20:00+01:00", "headline": "Handling data with the Angular AsyncPipe", "mainEntityOfPage": {"@type": "WebPage", "@id": "../../../2017/Apr/09/async-angular-data.html"}, "@context": "http://schema.org", "@type": "BlogPosting", "dateModified": "2017-04-16T15:00:00+01:00", "description": "Patterns for manipulating API data asynchronously using RxJS Observables in Angular."}
</script>
    </div>

    <div class="column is-one-quarter-desktop is-one-third-tablet is-hidden-print">
      <aside class="menu">
<div id="mc_embed_signup">
  <form
      action="https://jonrshar.us15.list-manage.com/subscribe/post?u=7ada11180797f3af73228bf0b&amp;id=d172abcbd2"
      method="post" id="mc-embedded-subscribe-form"
      name="mc-embedded-subscribe-form" class="validate" target="_blank"
      novalidate>

    <h2 class="menu-label">Mailing List</h2>

    <div id="mc_embed_signup_scroll">
      <div class="field mc-field-group">
        <label for="mce-EMAIL" class="label is-small">Email</label>
        <div class="field-body">
          <div class="field">
            <p class="control has-icons-left">
              <input type="email" name="EMAIL" class="input required email is-small"
                     id="mce-EMAIL" placeholder="Email address">
              <span class="icon is-small is-left">
              <i class="fa fa-envelope"></i>
            </span>
            </p>
          </div>
        </div>
      </div>
      <div class="field">
        <label for="mce-FNAME" class="label is-small">Name</label>
        <div class="field-body">
          <div class="field is-grouped">
            <p class="control is-expanded">
              <input class="input is-small" type="text" value="" name="FNAME"
                     id="mce-FNAME" placeholder="First">
            </p>
            <p class="control is-expanded">
              <input class="input is-small" type="text" value="" name="LNAME"
                     id="mce-LNAME" placeholder="Last">
            </p>
          </div>
        </div>
      </div>
      <div class="field is-grouped">
        <p class="control">
          <input type="submit" name="subscribe" value="Subscribe"
                 class="button is-small is-success" id="mc-embedded-subscribe">
        </p>
          <p class="control">
            <span class="help">
              Powered by
              <a href="http://eepurl.com/cNv6Rb"
                 title="MailChimp - email marketing made easy and fun">
                MailChimp
              </a>
            </span>
          </p>
      </div>

      <div id="mce-responses" class="clear">
        <div class="response help is-danger" id="mce-error-response"
             style="display:none"></div>
        <div class="response help is-success" id="mce-success-response"
             style="display:none"></div>
      </div>

      <div style="position: absolute; left: -5000px;" aria-hidden="true">
        <input type="text" name="b_7ada11180797f3af73228bf0b_d172abcbd2"
               tabindex="-1" value="">
      </div>
    </div>
  </form>
</div>

          <p class="menu-label">Other Pages</p>
          <ul class="menu-list">
                <li><a                        href="../../../pages/about.html">
                  <span class="icon is-small"><i class="fa fa-book"></i></span>
                  <span class="link-text">About</span>
                </a></li>
          </ul>
          <p class="menu-label">Links</p>
          <ul class="menu-list">
              <li><a href="http://engineering.pivotal.io/">
                <span class="icon is-small"><i class="fa fa-globe fa-fw"></i></span>
                <span class="link-text">Pivotal Engineering Journal</span>
              </a></li>
              <li><a href="http://blog.cleancoder.com/">
                <span class="icon is-small"><i class="fa fa-globe fa-fw"></i></span>
                <span class="link-text">The Clean Code Blog</span>
              </a></li>
              <li><a href="https://codeascraft.com/">
                <span class="icon is-small"><i class="fa fa-globe fa-fw"></i></span>
                <span class="link-text">Code as Craft</span>
              </a></li>
              <li><a href="http://corgibytes.com/blog/">
                <span class="icon is-small"><i class="fa fa-globe fa-fw"></i></span>
                <span class="link-text">Corgibytes Blog</span>
              </a></li>
          </ul>
<p class="menu-label">Social</p>
<ul class="menu-list">
    <li><a href="https://github.com/textbook">
      <span class="icon is-small">
          <i class="fa fa-github fa-fw"></i>
      </span>
      <span class="link-text">GitHub</span>
    </a></li>
    <li><a href="http://stackoverflow.com/users/3001761/jonrsharpe">
      <span class="icon is-small">
          <i class="fa fa-stack-overflow fa-fw"></i>
      </span>
      <span class="link-text">Stack Overflow</span>
    </a></li>
    <li><a href="https://twitter.com/jonrsharpe">
      <span class="icon is-small">
          <i class="fa fa-twitter fa-fw"></i>
      </span>
      <span class="link-text">Twitter</span>
    </a></li>
    <li><a href="https://500px.com/jonrsharpe">
      <span class="icon is-small">
          <i class="fa fa-500px fa-fw"></i>
      </span>
      <span class="link-text">500px</span>
    </a></li>


</ul>          <p class="menu-label">License</p>
          
<ul class="menu-list">
  <li>
    <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
      <span class="icon is-small">
        <i class="fa fa-creative-commons fa-fw"></i>
      </span>
      <span>CC BY-SA 4.0</span>
    </a>
  </li>
</ul>

      </aside>
    </div>
  </div>
</div>

<footer class="footer">
  <div class="container has-text-centered">
 <p class="subtitle">These are my opinions - if you don't like them, I have others</p>    <div class="credits">
      <span><a href="https://github.com/textbook/bulrush">Bulrush</a> theme for
        <a href="https://blog.getpelican.com/">Pelican</a></span>
      <span><span class="icon is-small"><i class="fa fa-html5"></i></span> HTML 5</span>
      <span><span class="icon is-small"><i class="fa fa-css3"></i></span> CSS 3</span>
      <span>Made with <a href="https://bulma.io">Bulma</a></span>
    </div>
  </div>
  <div class="github-fork-ribbon-wrapper is-hidden-mobile is-hidden-print">
    <div class="github-fork-ribbon">
      <a href="https://github.com/textbook/textbook.github.io-source">
        <i class="fa fa-github fa-fw"></i>
        Fork me on GitHub
      </a>
    </div>
  </div>
</footer>

<script type="text/javascript">
  document.getElementById('navToggle').addEventListener('click', function () {
    var nav = document.getElementById('navMenu');
    var className = nav.getAttribute('class');
    if (className == 'navbar-menu') {
      nav.className = 'navbar-menu is-active';
    } else {
      nav.className = 'navbar-menu';
    }
  });
</script>
</body>
</html>